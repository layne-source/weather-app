# 天气应用 (Weather App)

## 项目概述

这是一个功能全面的天气预报应用，为用户提供实时天气信息、空气质量数据和未来天气预报。应用采用现代化的UI设计，支持深色模式，并提供丰富的天气相关数据。系统架构采用分层设计，实现了高效的缓存机制，提供离线访问和数据持久化功能。

## 功能特点

- **实时天气**: 显示当前温度、天气状况、体感温度等信息
- **天气预报**: 提供未来7天的天气预报
- **空气质量**: 详细展示AQI、PM2.5、PM10等空气质量指标
- **城市管理**: 支持添加、删除和切换多个城市
- **生活指数**: 提供穿衣、运动、旅行、洗车等多种生活指数
- **离线模式**: 支持无网络环境下使用缓存数据
- **深色模式**: 支持深色主题，保护夜间视力
- **定位功能**: 支持使用当前位置获取天气信息
- **下拉刷新**: 提供下拉刷新功能，方便用户获取最新天气数据
- **智能缓存**: 实现了基于使用频率的动态缓存管理系统

## 系统架构

应用采用分层架构设计，主要分为以下几层：

1. **表现层**：Activity和UI组件，负责界面展示和用户交互
2. **网络层**：WeatherApi类，封装和风天气API的网络请求
3. **缓存层**：WeatherDataCache类，实现数据缓存策略
4. **数据持久层**：SharedPreferences实现的数据存储
5. **模型层**：Weather和City等数据模型类

### 数据流

```
用户操作 → Activity → WeatherApi → 网络请求/缓存数据 → 数据处理 → UI更新
```

- 用户操作触发数据加载请求
- 先检查缓存是否有效，无效或过期则请求网络
- 网络数据获取后存入缓存系统
- 数据处理后通过UI组件展示给用户

## 技术栈

- **开发语言**: Java
- **最低SDK版本**: Android 10 (API 29)
- **目标SDK版本**: Android 14 (API 34)
- **网络请求**: OkHttp 4.10.0
- **JSON解析**: Gson 2.9.0
- **缓存策略**: 自定义LRU内存缓存 + SharedPreferences持久化
- **UI组件**: 
  - Material Components 1.9.0
  - AndroidX AppCompat 1.6.1
  - ConstraintLayout 2.1.4
  - RecyclerView 1.3.0
  - CardView 1.0.0
  - SwipeRefreshLayout 1.1.0

## 项目结构

```
com.microntek.weatherapp/
├── adapter/
│   └── CityAdapter.java            # 城市列表适配器
├── api/
│   └── WeatherApi.java             # 天气API接口封装
├── model/
│   ├── City.java                   # 城市数据模型
│   ├── Weather.java                # 天气数据模型
│   └── DailyForecast.java          # 每日预报数据模型(Weather内部类)
├── ui/
│   ├── AirQualityActivity.java     # 空气质量详情页面
│   ├── CityManagerActivity.java    # 城市管理页面
│   └── SettingsActivity.java       # 设置页面
├── util/
│   ├── AirPollutionUtil.java       # 空气污染指数工具类
│   ├── CityPreferences.java        # 城市偏好设置工具类
│   ├── ThemeHelper.java            # 主题管理工具类
│   ├── WeatherBackgroundUtil.java  # 天气背景生成工具类
│   └── WeatherDataCache.java       # 天气数据缓存管理器
└── MainActivity.java               # 主页面
```

## 缓存系统设计

应用实现了一个高效的多级缓存系统，具有以下特点：

1. **分级缓存**：
   - 内存缓存：使用LruCache实现，提供最快的数据访问
   - 磁盘缓存：使用SharedPreferences实现持久化存储
   - 备份机制：定期创建重要数据备份，防止数据损坏

2. **智能缓存策略**：
   - 基于使用频率的动态缓存更新间隔
   - 不同类型数据设置不同的缓存有效期
   - 自动清理过期缓存数据

3. **容错机制**：
   - 错误计数和自动修复损坏的缓存
   - 备份恢复机制，在主缓存损坏时自动从备份恢复
   - 离线模式下的数据可用性保证

4. **资源优化**：
   - 启动时清理过期缓存数据
   - 应用退出时安全关闭资源，防止泄漏
   - 存储空间不足时智能调整备份策略

## 最近优化

### 缓存系统
- **实现了多级缓存策略**：内存缓存、磁盘缓存和备份缓存互相配合，提高数据访问速度和可靠性
- **添加了缓存验证与修复机制**：应用可自动检测并修复损坏的缓存数据
- **优化了缓存备份策略**：定期备份重要数据，防止数据丢失
- **完善了错误处理**：添加了重试机制和错误计数，提高系统稳定性

### 城市管理与缓存集成
- **优化了城市管理与缓存机制的协作**：
  - 添加城市时自动预加载并缓存天气数据
  - 删除城市时自动清除相关缓存数据
  - 切换城市时优先加载当前城市的天气数据
  - 应用启动或从后台恢复时智能同步所有城市的缓存数据
- **改进了异步处理**：
  - 所有城市管理操作（添加、删除、切换）均在后台线程执行，避免UI卡顿
  - 使用线程池管理后台任务，防止资源泄漏
  - 添加了加载状态指示器，提升用户体验
- **增强了错误处理**：
  - 添加了详细的错误日志记录
  - 实现了用户友好的错误提示和重试机制
  - 防止重复操作导致的异常

### 资源管理
- **完善了资源释放机制**：
  - 在Activity或应用销毁时自动关闭线程池和释放资源
  - 使用Single-Thread Executor避免过多任务积压
  - 实现了优雅的资源释放流程

### 其他优化
- **资源泄漏修复**：完善了资源关闭机制，防止内存泄漏
- **缓存系统增强**：实现了基于使用频率的动态备份间隔
- **线程安全性提升**：为所有缓存操作添加了同步机制
- **错误处理增强**：改进了缓存错误检测和恢复机制
- **代码优化**：移除了未使用的代码和方法，提高代码质量
- **UI优化**：添加了下拉刷新功能和更新时间显示
- **离线模式增强**：改进了网络不可用时的用户体验

## 使用说明

1. 首次启动时，应用会默认显示北京的天气情况
2. 点击城市名称可进入城市管理页面添加或切换城市
3. 通过底部导航栏可以快速访问首页、城市管理、空气质量和设置页面
4. 在设置页面可以切换深色模式
5. 下拉刷新可以获取最新的天气数据
6. 离线模式下会自动显示最近缓存的天气数据

## 开发配置

### 前提条件

- Android Studio Hedgehog | 2023.1.1或更高版本
- JDK 1.8或更高版本
- 和风天气API密钥（需要在WeatherApi.java中替换为自己的API_KEY）

### 构建步骤

1. 克隆项目到本地
2. 在Android Studio中打开项目
3. 在WeatherApi.java中替换API_KEY为自己的和风天气API密钥
4. 构建并运行项目

## API密钥设置

在使用应用前，需要在`WeatherApi.java`文件中替换为自己的和风天气API密钥：

```java
// 和风天气API密钥和基础URL
private static final String API_KEY = "YOUR_API_KEY"; // 请替换为您自己的API密钥
```

## 注意事项

- 应用使用和风天气API，请确保有足够的API调用额度
- 位置权限用于获取当前位置的天气信息，请在使用时授予应用相关权限
- 首次启动时可能需要网络连接来获取初始数据
